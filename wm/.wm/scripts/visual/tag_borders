#!/bin/sh


b_width=$(bspc config border_width)

# you can move this into the render function

draw() {
    active=$(bspwindows)
    state=$(btags state-plain)

    for wid in $active $(bspwindows inactive); do
	tag=$(echo "$state" | awk -F \| "/$wid/{print \$4}" | head -n 1)
	if [ -z "$tag" ]; then
	    if echo "$active" | grep -q "$wid"; then
		chwbn \
		    -b $(( b_width-4 )) \
		    -b $(( 4 )) \
		    -c 000000 \
		    -c 666666 \
		    $wid
	    else
		chwbn -b $b_width -c 000000 $wid
	    fi
	else
	    color=$(echo "$state" | awk -F \| "/$wid/{print \$3}" | head -n 1)

	    if echo "$active" | grep -q "$wid"; then
		chwbn \
		    -b $(( b_width-4 )) \
		    -b $(( 4 )) \
		    -c $color \
		    -c $(colort -l -40 $color) \
		    $wid
	    else
		chwbn -b $b_width -c $color $wid
	    fi
	fi
    done
}


normal=$(theme getval b_normal_border_color)
normal=$(theme getval background)
focused=$(theme getval b_focused_border_color)

# banded experiment
draw_new() {
    active=$(bspwindows)
    state=$(btags state-plain)

    for wid in $active $(bspwindows inactive); do
	if echo "$state" | grep $wid | grep -q true; then
	    border_color=$focused
	else
	    border_color=$normal
	fi

	# wowie
	# awk sure is the best
	args=$(echo "$state" | tac | awk -F\| /${wid}/'{print "-b 2 -c " $3 " -b 0 -c BC"};!'/${wid}/'{print "-b 2 -c BC"'} | \
	    tr $'\n' ' ' | \
	    sed "s/BC/${border_color}/g")

	echo chwbn -b 1 -c $border_color $args -b 1 -c $border_color $wid
	chwbn $args -b 2 -c $border_color $wid
    done
}

draw
# bspc subscribe node_flag node_state node_geometry node_focus | debounce.sh 0.1 | while read msg; do
bspc subscribe node_flag node_state node_geometry node_focus | while read msg; do
    draw
done
