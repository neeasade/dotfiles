#!/usr/bin/env bash

# ;; OK: underline when inactive but with wids
# ;; else just background color if active, no background if not turned on

render() {
    current=$(bspc query -N -n)

    result=$(btags state-plain | while read name active color wids; do
	tag_name=$name

	background=$(theme getval p_bg_normal)

	if $active; then
	    if [ ! -z "$wids" ]; then
		background=$color
	    fi
	else
	    if [ ! -z "$wids" ]; then
		name="${name}*"
	    fi
	fi

	border=
	if echo "$wids" | grep -q $current; then
	    border=$(colort -l -40 $color)
	    name="${name}!"
	fi

	# height of the under/over determined from bar itself
	name=$(bs ":${name}" "A3btags toggle-wids $tag_name \$(bspwindows)" "A1btags toggle $tag_name")

	printf '%s' "$(echo "$name" | border=$border bg=$background season)"
    done
    )

    printf '%s\n' "$result"
}

render

bspc subscribe node_flag node_state node_geometry node_focus | debounce.js 10 | \
    while read -r trigger; do
	render
    done
