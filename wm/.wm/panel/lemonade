#!/usr/bin/env bash

# regen i3blocks config:
# theme refresh lemonade

# eg desktop:circe_dms:title|org_task|mpd:volume:clock
# -> $desktop $circe_dms $title %{c}$org_task %{r}mpd $volume $clock
p_format=$(theme getval p_format)
# p_format='tags:chunks:title|org_task|mpd:weather:clock'

format=$(echo "$p_format" | sed 's/:/$/g' | sed 's/|/%{c}$/' | sed 's/|/%{r}$/' )
format="\$$format"

# stdbuf -oL all the things.
# this has been poked at alot by a tired me, I think it's good now.
stdbuf -oL i3blocks -o j | \
    stdbuf -oL sed 's/\},/}\n,/g' | \
    stdbuf -oL sed -e 's/^,//' -e 's/\[//' -e 's/\]$//' | \
    stdbuf -oL grep '^{' | \
    stdbuf -oL jq -r '.name + " " + .full_text' | \
    stdbuf -oL sed "s#'#\'\\\'\'#g" | \
    while IFS=$'\n' read -r event; do
	eval "${event%% *}=\${event#* }"
	eval "echo \"$format\""
    done | stdbuf -oL debounce.js 30
