#!/bin/sh

# todo:
# line={{p_line}}
# padding={{p_padding}}
# bg = "{{p_bg_middle}}"
# fg = "{{p_fg_normal}}"
# format = "{{p_format}}"
# fonts = "{{p_font_main}}"
#         "{{p_font_icon}}"
#         "font-linux-10"
# class = "{{p_window_class}}"
# offset = {{p_offset}}
# clickables = {{{echo "3 * $(echo $lemons | wc -w)" | bc}}}

# eg desktop:circe_dms:title|org_task|mpd:volume:clock
# -> $desktop $circe_dms $title (C)$org_task (L)mpd $volume $clock
p_format=$(theme getval p_format)
format=$(echo "$p_format" | sed 's/:/$/g' | sed 's/|/%{c}$/' | sed 's/|/%{r}$/' )
format="\$$format"
echo "format: $format"

# i3blocks -o j | stdbuf -oL sed 's/\},/}\n,/g' | sed -e 's/^,//' -e 's/\[//' -e 's/\]$//' | \
#stdbuf -oL all the things
# i3blocks -o j | debounce.sh 0.01 | stdbuf -oL sed 's/\},/}\n,/g' | stdbuf -oL sed -e 's/^,//' -e 's/\[//' -e 's/\]$//' | \
i3blocks -o j | stdbuf -oL sed 's/\},/}\n,/g' | stdbuf -oL sed -e 's/^,//' -e 's/\[//' -e 's/\]$//' | \
    stdbuf -oL grep '^{' | \
    stdbuf -oL jq -r ".name + \"='\" + .full_text + \"'\" " | \
    while read -r line; do
	eval "$line"
	eval "echo \"$format\""
done | debounce.js | lemonbar
