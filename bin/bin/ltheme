#!/bin/sh
# Load a bspwm theme based on argument
# This loads settings for: bspwm, termite, tmux, vim, lemonbar, GTK/Icons, qutebrowser, dunst.

unset block
rm ~/.bspwm_theme
ln -s ~/.config/bspwm/themes/${1}.bspwm_theme ~/.bspwm_theme
. ~/.bspwm_theme

rm ~/.config/termite/config
ln -s ~/.config/termite/themes/${TERMITE_CONFIG}.config ~/.config/termite/config

# tell all termites to reload their theme:
killall -s USR1 termite &

# tell tmux to reload it's theme
tmux source-file ~/.tmux.conf > /dev/null &

# set the background
$BG_COMMAND &

# Keep the current gap setting and reload bspwm
[[ $(bspc config window_gap) -le 0 ]] && export BSPWM_GAPS=false \
                                      || export BSPWM_GAPS=true

~/.config/bspwm/bspwmrc &

# vim reload
VIMS=`vim --serverlist`
for vim in $VIMS; do
    vim --servername $vim --remote-send '<Esc>:so $MYVIMRC<CR>'
done

# GTK
cp ~/.gtkrc-2.0.back  ~/.gtkrc-2.0
sed -i "s/replaceThemeName/$THEME_NAME/g;s/replaceFontName/$GTK_FONT/g;" ~/.gtkrc-2.0

# trim transparency from colors to be used in gtk and qutebrowser
# ugh gross todo: clean
pFG="$(echo $pFG | cut -c4-)"
pBG="$(echo $pBG | cut -c4-)"
pFGActiveTab="$(echo $pFGActiveTab | cut -c4-)"
pBGActiveTab="$(echo $pBGActiveTab | cut -c4-)"

# make gtk theme if it does not exist.
if [ ! -d "$HOME/.themes/oomox-$THEME_NAME" ]; then
    target="$HOME/.themes/.oomox/colors/$THEME_NAME.sh"
    cp $HOME/.themes/oomox_template $target
    sed -i "s/replaceThemeName/$THEME_NAME/g;" $target
    sed -i "s/replacepFGActiveTab/$pFGActiveTab/g;" $target
    sed -i "s/replacepBGActiveTab/$pBGActiveTab/g;" $target
    sed -i "s/replacepFG/$pFG/g;" $target
    sed -i "s/replacepBG/$pBG/g;" $target
    $HOME/.themes/.oomox/change_color.sh "$THEME_NAME"
fi

# set icon color(ACYL)
$HOME/.icons/acyl/scalable/scripts/icon.sh "$GTK_ICON_COLOR"

# load it:
gtkrc-reload &

# cp the qutebrowser config and replace the colors with this theme's colors.
quteconf="$HOME/.config/qutebrowser/qutebrowser.conf"
cp "$HOME/.config/qutebrowser/qutebrowser.conf.template" "$quteconf"

# match tabs to panel.
sed -i "s/replaceQuteFG/#$pFG/g;s/replaceQuteBG/#$pBG/g;" $quteconf
sed -i "s/replaceQuteActiveTabFG/#$pFGActiveTab/g;s/replaceQuteActiveTabBG/#$pBGActiveTab/g;" $quteconf

# Kill dunst and restart with the right colors.
killall dunst

# reset $defaultBG and FG for dunst relaunch:
dunst -geometry 200x200-10-10 \
    -fn "$DUNST_FONT" \
    -lb "#$pBG" -lf "#$pFG" \
    -nb "#$pBG" -nf "#$pFG" \
    -cb "#$pFG" -cf "#$pBG" &

sleep 0.5

notify-send "Theme $1 loaded."
